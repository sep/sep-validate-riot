<sep-form>
    <form onsubmit="{ noop }" onreset="{ noop }" ref="form">
      <yield/>
    </form>

    <script>
        this.freshData = () => ({ });
        this.addTo = (property, value) => {
            return () => this.data[property].push(value || {});
        };
        this.removeFrom = (property) => {
            return ((event) => {
                this.data[property].splice(event.item.index, 1);
                this.update();
            });
        };
        this.fileUploaded = (event) => {
            event.preventUpdate = true;
            var localFile = event.target.files[0];
            var reader = new FileReader();
            reader.onload = (read) => {
                var data = JSON.parse(read.target.result);
                data.filename = localFile.name;
                this.setData(data);
                this.update();
            };
            reader.readAsText(localFile);
            event.target.value = null;
        };
        this.serialize = () => {
            return $(this.refs.form).find('input, select')
                .serializeJSON({
                    useIntKeysAsArrayIndex: true,
                    customTypes: {
                        number: (strValue) => { return strValue == "" ? null : Number(strValue); }
                    }
                });
        };
        this.validate = (event) => {
            event.preventUpdate = true;
            this.removeValidations();
            this.revalidate = "Revalidate";
            $.ajax({
                type: "POST",
                url: this.opts.validationUrl,
                dataType: "json",
                contentType: "application/json; charset=utf-8",
                data: JSON.stringify(this.serialize()),
                success: this.processValidationResponse
            });
        };
        this.downloadFile = () => {
            event.preventUpdate = true;
            event.preventDefault();
            var data = this.serialize();
            var filename = data.filename || "my";
            if (!filename.toLowerCase().endsWith(".json")) {
                filename += ".json";
            }
            delete data.filename;
            this.downloadData(data, filename);
            return false;
        };
        this.downloadData = (data, filename) => {
            var blob = new Blob([JSON.stringify(data, null, "\t")]);
            if (window.navigator.msSaveOrOpenBlob) {
                window.navigator.msSaveOrOpenBlob(blob, filename);
            } else {
                var link = document.createElement('a');
                link.href = window.URL.createObjectURL(blob);
                link.download = filename;
                link.click();
            }
        };
        this.setData = (data) => {
            this.data = Object.assign(this.freshData(), data || {});
            this.removeValidations();
        };
        this.removeValidations = () => {
            $("sep-validation").each((i, el) => el._tag.reset());
            $(".form-group").removeClass("has-error");
            $(".panel").removeClass("panel-danger");
            delete this.result;
            delete this.revalidate;
        };
        this.dismiss = () => (this.dismissed = true);
        this.reset = () => this.setData();
        this.processValidationResponse = (response) => {
            if (!response.isSuccess) {
                $.each(Object.keys(response.errorsByKey), (index, key) => {
                    var errorMessages = response.errorsByKey[key];
                    var validationWidgets = $("sep-validation[key='" + key + "'], sep-validation[key^='" + key + ":']");
                    if (validationWidgets.length) {
                        validationWidgets.closest(".form-group").addClass("has-error");
                        validationWidgets.closest(".panel").addClass("panel-danger");
                        validationWidgets.each((i, el) => el._tag.setMessages(errorMessages));
                    } else {
                        alert("validation messages not handled for key: " + key);
                    }
                });
                this.setResult("There are some problems.", false);
            } else {
                this.removeValidations();
                this.setResult("Everything looks good.", true);
            }
            this.update();
        };
        this.scrollToFirstValidationError = (e) => {
            e.preventDefault();
            e.preventUpdate = true;
            $('html, body').animate({
                scrollTop: $(".panel-danger").offset().top - $(".sticky").outerHeight() - 30
            }, 750);
            return false;
        };
        this.setResult = (message, isSuccess) => {
            this.result = {
                message: message,
                success: isSuccess
            };
            delete this.dismissed;
        };
        this.on("before-mount", () => {
            this.data = this.freshData();
        });
        this.on("mount", () => {
            $(this.refs.form).find(".alert").alert();
        });
        this.noop = (e) => {
          e.preventDefault();
          e.preventUpdate = true;
          return false;
        }
    </script>
</sep-form>
